<!DOCTYPE html>
<html>
<head>
	<title>The Ghost, Buster</title>
	<script>
		//Game Variables
		var canvas;
		var pen;
		var sprite;
		var titleScreen;
		var fps = 10;
		var playerLocation;
		var MAX_HEIGHT = 200;
		var MAX_WIDTH = 400;
		var MIN_HEIGHT = 0;
		var MIN_WIDTH = 0;
		var count = 0;
		var score;
		var spriteX = 0;

		//Background Variables
		var x = 0;
		var y = 6;
		var BKGD_HEIGHT;
		var BKGD_END = 800;
		var background;

		//Player Variables
		var playerX = 100;
		var playerY = 50;
		var PLAYER_WIDTH = 17;
		var PLAYER_HEIGHT = 17;
		var playerState;	//Set to animation type
		var PSPEED = 5;
		var invincibleCount = 0;
		var pLives = 3;
		var nextLife = 1000;
		var MAX_LIVES = 5;
		
		//Power Up Variables
		var pUps = [];	//list of dictionaries, with "locX", "locY", "active"
		var PWIDTH = 14;
		var PHEIGHT = 14;
		
		//Bullets
		var bullets = [];	//list of dictionaries, with "bulletX", "bulletY", "age", "dir"
		var BULLET_WIDTH = 4;
		var BULLET_HEIGHT = 2;
		var MAX_BULLETS = 5;
		var BSPEED = 5;
		var BSTRENGTH = 1;

		//Enemy Variables
		var enemies = [];	// list of dictionaries, with "locX", "locY", "type", "active", "state", "lives", "worth"
		var ENEMY_WIDTH = 17;
		var ENEMY_HEIGHT = 17;
		var ESPEED = 1;
		var BOSS_TIME = 900;

		function init()
		{
			canvas = document.getElementById("scene");
			pen = canvas.getContext("2d");
			
			//Get images and sounds
			titleSound = document.getElementById("titleMusic");
			sprite = new Image();
			sprite.src = "spritesheet.png";
			
			//Setup game, start title screen and music
			document.addEventListener('keydown', callback, false);
			playerLocation = "title";
			if (localStorage['high'] == undefined)
				localStorage['high'] = 0;
			count = 0;
			setInterval(gameLoop, 1000 / fps);
			titleSound.play();
		}
		
		//callback for key presses
		function callback(event)
		{
			//console.log(event.keyCode);
			//m-key to mute music
			if (event.keyCode == 77)
			{
				if (titleSound.paused)
					titleSound.play();
				else
					titleSound.pause();
			}
			//Start the game and spawn enemies/ power ups if a key is pressed on title screen
			else if (playerLocation == "title")
			{
				playerLocation = "game";
				score = 0;
				enemyAdder = setInterval(addEnemy, 10000);
				pUpAdder = setInterval(addPUp, 30000);
				count = 0;
				playerState = "STAND";
				enemies.push({"locX": 300, "locY": 10, "type": "ghost", "active": false, "state": "LEFT", "worth": 100, "lives": 1});
				enemies.push({"locX": 500, "locY": 10, "type": "ghost2", "active": false, "state": "LEFT", "worth": 100, "lives": 5});
				pUps.push({"locX": 100, "locY": 100, "active": false});
			}
			//Game controls unless dead - arrow keys for player controls
			else if (playerState != "DEAD")
			{	
				if (event.keyCode == 39)
				{
					if (x < BKGD_END)
					{
						x += PSPEED;
						for (var i = 0; i < enemies.length; i++)
						{
							enemies[i]["locX"] -= ESPEED;
						}
						for (var i = 0; i < pUps.length; i++)
						{
							pUps[i]["locX"] -= PSPEED;
						}
					}
					playerState = "RIGHT";
				}
				else if (event.keyCode == 37)
				{
					if (x > 0)
					{
						x -= PSPEED;
						for (var i = 0; i < enemies.length; i++)
						{
							enemies[i]["locX"] += ESPEED;
						}
						for (var i = 0; i < pUps.length; i++)
						{
							pUps[i]["locX"] += PSPEED;
						}
					}
					playerState = "LEFT";
				}
				else if (event.keyCode == 40)
				{
					if (playerY < MAX_HEIGHT - PLAYER_HEIGHT)
						playerY += PSPEED;
				}
				else if (event.keyCode == 38)
				{
					if (playerY > 0)
						playerY -= PSPEED;
				}
				else if (event.keyCode == 32 && bullets.length < MAX_BULLETS)
				{
					bullets.push({"bulletX": playerX + 6, "bulletY": playerY + 5, "age": 0, "dir": playerState});
				}
			}
		}
		
		//Check for collisions by seeing if any of four corners are within other box
		function collide(x1, y1, x2, y2, width1, height1, width2, height2)
		{
			if ((x1 >= x2 && x1 <= x2 + width2 && y1 >= y2 && y1 <= y2 + height2) ||
							(x1 >= x2 && x1 <= x2+ width2 && y1 +  height1 >= y2 && y1 +  height1 <= y2 + height2) ||
							(x1 + width1 >= x2 && x1 + width1 <= x2 + width2 && y1 >= y2 && y1 <= y2 + height2) ||
							(x1 + width1 >= x2 && x1 + width1 <= x2 + width2 && y1 +  height1 >= y2 && y1 +  height1 <= y2 + height2))
							{
								return true;
							}
			return false;
		}
		
		//Spawn an enemy (called on an interval)
		function addEnemy()
		{
			var rand = Math.floor(Math.random() * 4);
			var type;
			var lives;
			var worth;
			if (rand == 1)
			{
				type = "ghost2";
				lives = 5;
				worth = 500;
			}
			else
			{
				type = "ghost";
				lives = 1;
				worth = 100;
			}
			//console.log("Adding an enemy!");
			enemies.push({"locX": Math.floor(Math.random() * BKGD_END), "locY":  Math.floor(Math.random() * MAX_HEIGHT), "type": type, "active": false, "lives": lives, "worth": worth});
		}
		
		//Span a pUp (called on an interval)
		function addPUp()
		{
			var newX = Math.floor(Math.random() * BKGD_END - playerX)  + playerX;
			var newY = Math.floor(Math.random() * MAX_HEIGHT);
			//console.log("Adding a powerup! at " + newX + "," + newY);
			pUps.push({"locY": newY, "locX": newX, "active": false});
		}
		
		function playerCollisions()
		{
			//Handle player lives: if there are none left, the game is over; score a certain amount to gain another life
			if (pLives < 0)
			{
				pen.fillStyle = "rgb(255,0,0)";
				pen.drawImage(sprite, 1, 154, 82, 10, MAX_WIDTH / 2 - 75, MAX_HEIGHT / 2 - 10, 164, 20);
				pen.fillText("FINAL SCORE: " + score, MAX_WIDTH / 2 - 50, MAX_HEIGHT / 2 + 20); 
				pen.fillText("HIGH SCORE: " + localStorage['high'], MAX_WIDTH / 2 - 50, MAX_HEIGHT / 2 + 30); 
			}
			else if (score > nextLife && pLives < MAX_LIVES)
			{
				pLives++;
				nextLife += 1000;
			}
			
			//Check for enemy collisions
			for (var i = 0; i < enemies.length; i++)
			{
				if (enemies[i]["active"])
				{
					if (collide(enemies[i]["locX"] - x, enemies[i]["locY"], playerX, playerY, ENEMY_WIDTH, ENEMY_HEIGHT, PLAYER_WIDTH, PLAYER_HEIGHT))
					{
						//Handle if player is not invincible; player loses life
						if (invincibleCount == 0)
						{
							pLives -= 1;
							if (pLives <= 0)
							{
								playerState = "DEAD";
								clearInterval(enemyAdder);
								clearInterval(pUpAdder);
							}
							else
							{
								if (playerState == "RIGHT" && x > 10)
									x -= 10;
								else if (playerState == "LEFT" && x < BKGD_END - 10)
									x += 10;
							}
						}
						else	//if the player is invincble, damage enemies
						{
							enemies[i]["lives"] -= 1;
							if (enemies[i]["lives"] <= 0)
							{
								score += enemies[i]["worth"];
								//handle killing a boss enemy - stop spawning
								if (enemies[i]["type"] == "boss")
								{
									playerLocation = "end";
									clearInterval(enemyAdder);
									clearInterval(pUpAdder);
									enemies.splice(i, 1);
									invincibleCount = 1;
								}
								else if (playerLocation == "end")
								{
									enemies.splice(i, 1);
								}
								else
								{
									enemies[i]["locX"] = Math.floor(Math.random() * BKGD_END);
									enemies[i]["locY"] = Math.floor(Math.random() * MAX_HEIGHT);
									if (enemies[i]["type"] == "ghost")
										enemies[i]["lives"] = 1;
									else
										enemies[i]["lives"] = 5;
								}
							}
						}
					}
				}
			}
		}
		
		function bulletHandle()
		{
			if (bullets.length > 0)
			{
				pen.fillStyle = "rgb(255,0,0)";
				for (var i = 0; i < bullets.length; i++)
				{
					if (bullets[i]["age"] >= 20)
						bullets.splice(i, 1);
					else
					{
						var killBullet = false;
						//Bullet-Enemy Collisions
						for (var a = 0; a < enemies.length; a++)
						{
							if (enemies[a]["active"] && !killBullet)
							{
								if (collide(bullets[i]["bulletX"], bullets[i]["bulletY"], enemies[a]["locX"] - x, enemies[a]["locY"], BULLET_WIDTH, BULLET_HEIGHT, ENEMY_WIDTH, ENEMY_HEIGHT))
								{
									//console.log("hit enemy!");
									enemies[a]["lives"] -= BSTRENGTH;
									if (enemies[a]["lives"] <= 0)
									{
										score += enemies[a]["worth"];
										//handle killing a boss enemy - stop spawning
										if (enemies[a]["type"] == "boss")
										{
											playerLocation = "end";
											clearInterval(enemyAdder);
											clearInterval(pUpAdder);
											enemies.splice(a, 1);
											invincibleCount = 1;
										}
										else if (playerLocation == "end")
										{
											enemies.splice(a, 1);
										}
										else
										{
											enemies[a]["locX"] = Math.floor(Math.random() * BKGD_END);
											enemies[a]["locY"] = Math.floor(Math.random() * MAX_HEIGHT);
											if (enemies[a]["type"] == "ghost")
												enemies[a]["lives"] = 1;
											else
												enemies[a]["lives"] = 5;
										}
									}
									killBullet = true;
								}
							}
						}
						
						//draw and move bullet if the bullet did not hit something
						if (!killBullet)
						{
							pen.fillRect(bullets[i]["bulletX"], bullets[i]["bulletY"], BULLET_WIDTH, BULLET_HEIGHT);
							if (bullets[i]["dir"] == "LEFT")
								bullets[i]["bulletX"] -= BSPEED;
							else
								bullets[i]["bulletX"] += BSPEED;
							bullets[i]["age"]++;
						}
						else
						{
							bullets.splice(i, 1);
						}
						//console.log(bullets[i]["age"]);
					}
				}
			}
		}
		
		function enemyHandle()
		{
			for (var i = 0; i < enemies.length; i++)
			{
				//Move enemies towards player
				if (enemies[i]["locX"] > x + playerX)
				{
					enemies[i]["locX"] -= ESPEED;
					enemies[i]["state"] = "LEFT";
				}
				else
				{
					enemies[i]["locX"] += ESPEED;
					enemies[i]["state"] = "RIGHT";
				}
				if (enemies[i]["locY"] > playerY)
				{
					enemies[i]["locY"] -= ESPEED;
				}
				else
				{
					enemies[i]["locY"] += ESPEED;
				}
				
				//check if enemy onscreen
				if (!(x <= enemies[i]["locX"] && enemies[i]["locX"] <= x + MAX_WIDTH))		//check to see if enemy moved off screen
				{
						enemies[i]["active"] = false;
				}
				else
				{
					enemies[i]["active"] = true;
				}
		
				//draw enemies if in frame
				if (enemies[i]["active"])
				{
					//console.log(enemies[i]);
					//Draw the different types of enemies
					if (enemies[i]["type"] == "ghost")
					{
						pen.drawImage(sprite, 21 + spriteX, 134, ENEMY_WIDTH, ENEMY_HEIGHT, enemies[i]["locX"] - x, enemies[i]["locY"], ENEMY_WIDTH, ENEMY_HEIGHT);
					}
					else if (enemies[i]["type"] == "ghost2")
					{
						switch (enemies[i]["lives"])
						{
							case 1: 
								pen.drawImage(sprite, 21 + spriteX, 134, ENEMY_WIDTH, ENEMY_HEIGHT, enemies[i]["locX"] - x, enemies[i]["locY"], ENEMY_WIDTH * 1.1, ENEMY_HEIGHT * 1.1); 
								break;
							case 2: 
								pen.drawImage(sprite, 21 + spriteX, 134, ENEMY_WIDTH, ENEMY_HEIGHT, enemies[i]["locX"] - x, enemies[i]["locY"], ENEMY_WIDTH * 1.2, ENEMY_HEIGHT * 1.2); 
								break;
							case 3: 
								pen.drawImage(sprite, 21 + spriteX, 134, ENEMY_WIDTH, ENEMY_HEIGHT, enemies[i]["locX"] - x, enemies[i]["locY"], ENEMY_WIDTH * 1.5, ENEMY_HEIGHT * 1.5); 
								break;
							case 4: 
								pen.drawImage(sprite, 21 + spriteX, 134, ENEMY_WIDTH, ENEMY_HEIGHT, enemies[i]["locX"] - x, enemies[i]["locY"], ENEMY_WIDTH * 2, ENEMY_HEIGHT * 2); 
								break;
							case 5: 
								pen.drawImage(sprite, 21 + spriteX, 134, ENEMY_WIDTH, ENEMY_HEIGHT, enemies[i]["locX"] - x, enemies[i]["locY"], ENEMY_WIDTH * 2, ENEMY_HEIGHT * 2); 
								break;
							default:
								break;
						}
					}
					else if (enemies[i]["type"] == "boss")
					{
						pen.drawImage(sprite, 43, 115, ENEMY_WIDTH, ENEMY_HEIGHT, enemies[i]["locX"] - x, enemies[i]["locY"], ENEMY_WIDTH * 2, ENEMY_HEIGHT * 2);
					}
				}
			}
		}
		
		function gameLoop()
		{
			if (titleSound.ended)
			{
				titleSound.play();
			}
			
			pen.clearRect(0, 0, MAX_WIDTH, MAX_HEIGHT);
			//Draw title screen
			if (playerLocation == "title")
			{
				pen.drawImage(sprite, 122, 87, 396, 200, 0, 0, MAX_WIDTH, MAX_HEIGHT);
			}
			//Draw in-game screen
			else
			{
				//Draw background
				pen.drawImage(sprite, x, y, 160, 80, 0, 0, MAX_WIDTH, MAX_HEIGHT);
				
				//Player, bullet, and enemy handling
				playerCollisions();
				bulletHandle();
				enemyHandle();
				
				//pUp Handling
				for (var i = 0; i < pUps.length; i++)
				{
					if (pUps[i]["active"])
					{
						if (collide(pUps[i]["locX"] - x, pUps[i]["locY"], playerX, playerY, PWIDTH, PHEIGHT, PLAYER_WIDTH, PLAYER_HEIGHT))
						{
							invincibleCount = 100;
							pUps.splice(i,1);
						}
						else
						{
							if (pUps[i]["locX"] < x || pUps[i]["locX"] > x + MAX_WIDTH)
							{
								pUps[i]["active"] = false;
							}
							else
							{
								pen.drawImage(sprite, 62, 114, PLAYER_WIDTH, PLAYER_HEIGHT, pUps[i]["locX"] - x, pUps[i]["locY"], PWIDTH, PHEIGHT);
							}
						}
					}
					else if (pUps[i]["locX"] >= x && pUps[i]["locX"] <= x + MAX_WIDTH)
					{
						pUps[i]["active"] = true;
					}
				}

				//Draw correct version of player character
				if (invincibleCount > 0)
				{
					pen.drawImage(sprite, 62 + spriteX, 133, PLAYER_WIDTH, PLAYER_HEIGHT, playerX, playerY, PLAYER_WIDTH, PLAYER_HEIGHT);
				}
				else if (playerState == "STAND")
				{
					pen.drawImage(sprite, 42 + spriteX, 95, PLAYER_WIDTH, PLAYER_HEIGHT, playerX, playerY, PLAYER_WIDTH, PLAYER_HEIGHT);
				}
				else if (playerState == "RIGHT")
				{
					pen.drawImage(sprite, 1 + spriteX, 114, PLAYER_WIDTH, PLAYER_HEIGHT, playerX, playerY, PLAYER_WIDTH, PLAYER_HEIGHT);
				}
				else if (playerState == "LEFT")
				{
					pen.drawImage(sprite, 83 + spriteX, 95, PLAYER_WIDTH, PLAYER_HEIGHT, playerX, playerY, PLAYER_WIDTH, PLAYER_HEIGHT);
				}
				else if (playerState == "DEAD")
				{
					pen.drawImage(sprite, 1, 132, PLAYER_WIDTH, PLAYER_HEIGHT, playerX, playerY, PLAYER_WIDTH, PLAYER_HEIGHT);
				}
				
				//Draw scores at bottom
				if (playerState != "DEAD" && playerLocation != "end")
				{
					pen.fillStyle = "rgb(255,0,0)";
					pen.fillText("SCORE: " + score, MIN_WIDTH + 2, MAX_HEIGHT - 10); 
					pen.fillText("HIGH SCORE: " + localStorage['high'], MAX_WIDTH - 150, MAX_HEIGHT - 10);
				}
				
				
				//Invincibility timer
				if (playerLocation != "end")
				{
					if (invincibleCount > 0)
						invincibleCount--;
					//console.log(count);
				}
				
				//Spawn the boss at appropriate time
				if (count >= BOSS_TIME && count < BOSS_TIME + 50)
				{
					if (count == BOSS_TIME)
					{
						enemies.push({"locX": 100, "locY": 100, "type": "boss", "active": false, "state": "RIGHT", "worth": 1500, "lives": 25});
						//console.log("boss added");
					}
					pen.fillText("Kill the boss to win the game!!", 150, 90);
				}
				
				//if at end, you've won!
				if (playerLocation == "end")
				{
					pen.drawImage(sprite, 1, 170, 64, 12, MAX_WIDTH / 2 - 75, MAX_HEIGHT / 2 - 10, 128, 20);
					pen.fillStyle = "rgb(255,0,0)";
					if (localStorage['high'] < score)
						localStorage['high']  = score;
					pen.fillText("FINAL SCORE: " + score, MAX_WIDTH / 2 - 50, MAX_HEIGHT / 2 + 20); 
					pen.fillText("HIGH SCORE: " + localStorage['high'], MAX_WIDTH / 2 - 50, MAX_HEIGHT / 2 + 30); 
				}
				
				//draw in player lives left
				var space = 10;
				for (var i = 0; i < pLives; i++)
				{
					pen.drawImage(sprite, 42, 94, PLAYER_WIDTH, PLAYER_HEIGHT, space, 10, PLAYER_WIDTH / 2, PLAYER_HEIGHT / 2);
					space += 10;
				}
				
				//Animation counter
				count++;
				if (count % 4 == 0)
				{
					if (spriteX == 0)
						spriteX = 20;
					else
						spriteX = 0;
				}
			}
		}
	</script>
</head>

<body onload = "init()">
	<canvas id="scene" width="400" height="200"></canvas>
	<audio src = "mixdown.wav" id = "titleMusic" ></audio>
</body>

</html>