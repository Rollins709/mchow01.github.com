<!DOCTYPE html>

<html>
<head>
<title> Ray Spartan (?)</title>
	<script>
		var canvas;
		var ctx;
		var fps = 60;
		var titleDim = [250,200];
		var platforms = [];
		var projectiles = [];
		var enemies = [];
		var etypes = ['grunt','elite','biker','copter']
		var scroll_speed = 4;
		var current_pos = 0;
		var over_count = 0;
		var offsets = [0,1940];
		var frame_count = 0;
		
		//colors
		var black = "rgb(0,0,0)";
		var white = "rgb(255,255,255)";
		var purple = "rgb(180,70,220)";
		
		// physics constants
		var g = 5.8; // acceleration 9.8m/s^2
		var t = 2/60; // delta time  (game seconds per real seconds)

		// Background img
		bg = new Image();
		bg.src = "background1.jpeg"
		
		// Ray img
		ray_img = new Image();
		ray_img.src = "sprites/minigun.gif";
		
		// Enemies
		biker_img = new Image();
		biker_img.src = "sprites/rebel_biker.png";
		copter_img = new Image();
		copter_img.src = "sprites/slugcopter.gif";
		soldiers_img = new Image();
		soldiers_img.src = "sprites/soldiers.png";
		
		
		
		// Player object
	function spawnPlayer() 
	{
			this.lives = 5;
			this.size = [110,90];
			this.coord = [-this.size[0],200];
			this.velocity = [3,1.5]
			this.fire = [false, 0, 4]; // is firing, counter, count-to-fire
			this.invincible = [false, 0];
			this.type = 'player';
			this.weapon = 'default';
			this.super = false;
			this.land = false;
			this.plat = undefined;
			this.timer = 0;
			this.health = 100;
			this.power = 0;
			this.frame = 45;
			this.count = 0;

			this.draw = function () {
				ctx.fillStyle = "rgb(0,0,255)"; 
				//ctx.fillRect(this.coord[0],	this.coord[1],this.size[0],this.size[1]);
				ctx.drawImage(ray_img, 63.5*this.count, player.frame, 60, 45, this.coord[0], this.coord[1], this.size[0], this.size[1]);
			}
			//this.die
			this.drawMeters = function() {
				var start = [20,15];
				var dim = [60, 185];
				var m_length = 135;
				ctx.fillStyle = white;
				ctx.strokeStyle = black;
				
				// health
				ctx.fillStyle = "rgb(255,0,0)";
				ctx.fillRect(start[0]+8, start[1]+m_length+8, 14, (this.health/100)*-m_length);
				ctx.strokeRect(start[0]+8, start[1]+m_length+8, 14, -m_length);
				ctx.fillStyle = black
				ctx.font = "24px Arial";
				ctx.fillText("H", start[0]+7, start[1]+m_length+35, 20);
				
				// power
				if (this.power == 100) { ctx.fillStyle = "rgb( " + Math.floor( Math.random()* 255) + ","+ Math.floor( Math.random()* 255) +","+ Math.floor( Math.random()* 255) +")"; 
				} else { ctx.fillStyle = "rgb(255,255,0)"; }
				ctx.fillRect(start[0]+34, start[1]+m_length+8, 14, (this.power/100)*-m_length);
				ctx.strokeRect(start[0]+34, start[1]+m_length+8, 14, -m_length);
				ctx.fillStyle = black				
				ctx.fillText("P", start[0]+33, start[1]+m_length+35, 20);
				
				// lives
				ctx.fillStyle = "rgb(40,120,230)"
				for (i=1;i<this.lives+1;i++)
				{
					ctx.beginPath();
					ctx.arc(start[0]+dim[0]+20, start[1]+i*30-15, 8, 0, 2*Math.PI)
					ctx.fill();
				}
			}
		}
		
		// proj calculator f(object) -> obj w/ updated positions or f(coord) -> return next coords
	function projUpdate(obj, makeUpdate) // true or false
	{
		if (makeUpdate==false) 
		{
			return [obj.coord[0] + obj.velocity[0] * .95, // next x value
					  obj.coord[1] - obj.velocity[1] - g*t]; // next y value
		}
		
		if (makeUpdate==true)
		{
			// update height
			obj.coord[1] -= obj.velocity[1];
	
			// update vertical velocity
			if (obj.land == true)
			{
				obj.velocity[1] *= 0;
			}
			else
			{
				obj.velocity[1] -= g*t;
			}
			
			// update distance
			obj.coord[0] += obj.velocity[0];
			
			// update horizontal velocity
			if (obj.land == true) {
			obj.velocity[0] *= .8;}
		}
	}

	// Platform objects
	function plat(x, y, w, h)
	{
		this.dim = [x,y,w,h];
		this.color = "rgb(200,200,200)";
		this.active = true;
		platforms.push(this);
	}
	
	// Projectile objects
	function proj(x,y,type)
	{
		this.color = "rgb(255,255,0)";
		this.size = [10,2];
		this.coord = [x,y];
		this.active = true;
		this.type = type;
		
		if (type == 'player' ) 
		{ 
			var type = 1;
		} 
		else 
		{ 
			var type = -1; 
		}
		
		this.velocity = [type*(scroll_speed+10), 0];
		
		if (this.type == 'copter') { 
			this.size = [10,10];
			this.velocity = [-scroll_speed, 0];
		}
		
		projectiles.push(this);
	}
	
	function enemy(type, plat, loc) // location is percentage based on plat
	{
		this.type = type;
		this.plat = plat;
		this.fire = [false, 0, 25];
		this.active = true;
		this.land = false;
		this.velocity = [0,0];		
		
		if (this.type == 'biker') {
			this.img = biker_img; 
			this.count = 0;
			this.frame = 400;
			this.FWidth = 67;
			this.FHeight = 45;
			this.size = [67*2,45*2];
		}
		if (this.type == 'copter') {
			this.img = copter_img; 
			this.count = 90; 
			this.frame = 270;
			this.FWidth = 90;
			this.FHeight = 70;
			this.size = [90*1.2, 70*1.2];
		}
		if (this.type == 'grunt') {
			this.img = soldiers_img; 
			this.count = 95; 
			this.frame = 0;
			this.FWidth = 45;
			this.FHeight = 52;
			this.size = [45*1.5, 55*1.5];
		}
		if (this.type == 'elite') {
			this.img = soldiers_img; 
			this.count = 0; 
			this.frame = 0;
			this.FWidth = 45;
			this.FHeight = 52;
			this.size = [45*1.5, 55*1.5];
		}
		
		if (this.type !== 'copter') {
			this.coord = [plat.dim[0]+plat.dim[2]*loc, plat.dim[1]-this.size[1]-3];
			if (this.type == 'grunt') { this.color = "rgb(180,70,255)"; }
			if (this.type == 'elite') { this.color = "rgb(40,80, 100"; }
			if (this.type == 'biker') { this.color = "rgb(0,255,40)"; }
		} else {
			this.color = "rgb(255,255,0)";
			this.fire = [false, 0, 25];
			this.coord = [plat.dim[0]+plat.dim[2]*loc, 60]; // copter flies at set height
		}
		
		this.draw = function () {
			ctx.fillStyle = this.color;
			ctx.drawImage(this.img, this.count, this.frame, this.FWidth, this.FHeight, this.coord[0], this.coord[1], this.size[0], this.size[1]);
		}
		
		enemies.push(this);
	}
	
	function checkCollisions()
	{
		for (var i in platforms)
		{
			if (platforms[i].active == true) 
			{
				checkPlatformCollisions(platforms[i]);
				for (var n in enemies) 
				{
					checkPlatformCollisions(platforms[i], enemies[n]);
				}
			}
		}
	
		for (var i in projectiles)
		{
			checkProjectileCollisions(projectiles[i]);
		}
		
		for (var i in enemies)
		{
			checkPlayerCollisions(enemies[i]);
		}
	}
	
	// platform landing
	function checkPlatformCollisions(plat, obj)
	{
		if (!obj){ var obj = player;}

		var current = obj.coord;
		var next = projUpdate(obj, false) // stores next coords
		
		if ( obj.land == true && // if on platform
			(current[0] < obj.plat.dim[0] || // outside left bound
			current[0] > (obj.plat.dim[0]+obj.plat.dim[2])) ) { // or outside right bound
			obj.land = false; // to prevent jumping after falling off cliff
		}
		
		if ( obj.velocity[1] < 0 && obj.land==false ) // only if falling 
		{
			if ( current[1] < plat.dim[1]-obj.size[1]  && // if current height above
				next[1] > plat.dim[1]-obj.size[1] && // and fell through plat
				next[0] > plat.dim[0] && // within left bound
				next[0] < (plat.dim[0]+plat.dim[2]) ) // within right bound
			{
				if (obj == player) { 
					land.play();
				}
				obj.land = true;
				obj.plat = plat;
				obj.coord[1] = (obj.plat.dim[1]-obj.size[1]); // set player on top of platform
			}
		}
		
		if ( obj.land == true)
		{
			obj.coord[1] = (obj.plat.dim[1]-obj.size[1]);
		}
	}
	
	function checkProjectileCollisions(proj)
	{
		var pl = proj.coord[0];
		var pr = proj.coord[0]+proj.size[0];
		var pt = proj.coord[1];
		var pb = proj.coord[1]+proj.size[1];
		
		// player projectiles
		if (proj.type == 'player')
		{
			for (var i in enemies)
			{
				var enemy = enemies[i];
				if (enemy.active == true)
				{	
					if (enemy.coord[0] <= pl &&
					enemy.coord[0]+enemy.size[0] >= pl &&
					enemy.coord[1] <= pb &&
					enemy.coord[1]+enemy.size[1] >= pt) {
					console.log("HIT");
					enemy.color = "rgb(255,0,0)";
					enemy.active = false;
					proj.active = false;
					player.power += 15;
					}
				}
			}
		}
		else // enemy projectiles
		{	
			if (player.invincible[0] == false &&
				player.coord[0] <= pl &&
				player.coord[0]+player.size[0] >= pl &&
				player.coord[1] <= pb &&
				player.coord[1]+player.size[1] >= pt) {
				console.log("DANGER");
				player.health -= 10;
				player.power += 2;
				proj.active = false;
				player.invincible[0] = true;
			}
		}
	}
	
	// also AI behavior
	function checkPlayerCollisions(enemy)
	{
		pl = player.coord[0];
		pr = pl + player.size[0];
		pt = player.coord[1];
		pb = pt + player.size[1];
		
		// collision with enemy
		if (enemy.active == true && player.invincible[0] == false)
		{
			if (enemy.coord[0] <= pr &&
				enemy.coord[0]+enemy.size[0] >= pl &&
				enemy.coord[1] <= pb &&
				enemy.coord[1]+enemy.size[1] >= pt) {
				hit.play();
				player.health -= 5;
				player.power += 5;
				player.invincible[0] = true;
			}
		}

		// enemy behavior
		enemy.coord[0] -= scroll_speed;
		
		if (enemy.type == 'copter' && enemy.coord[0] < player.coord[0]+1100)
		{
			enemy.coord[0] -= 1.5*scroll_speed;
		}
		
		if (enemy.type == 'biker' && enemy.coord[0] < player.coord[0]+1000)
		{
			enemy.velocity[0] += -2;
			if (enemy.coord[0] < enemy.plat.dim[0]+10)
			{
				enemy.velocity[0] = 0;
			}
		}
		
		// if grunts or elites are within range
		if ( enemy.type == 'grunt' || enemy.type == 'elite' &&
			enemy.coord[0] < player.coord[0]+400 && 
			enemy.coord[0]+enemy.size[0] > 0) 
		{
			enemy.fire[0] = true;
			// if not close to edge, move
			if (enemy.coord[0] > enemy.plat.dim[0]+4)
			{	
				if (enemy.type == 'grunt')
				{
					enemy.velocity[0] = -1;
				}
				
				if (enemy.type == 'elite' && enemy.land == true)
				{
					enemy.color = "rgb(255,0,0)";
					enemy.velocity[0] = -2;
					enemy.velocity[1] = 7;
					enemy.land = false;
				}
			}
		} 
		else 
		{
		enemy.fire[0] = false;
		}
	}		
	
	function handleInvincibility()
	{
		if (player.invincible[0] == true && player.invincible[1] < 75) {
			player.invincible[1]++;
		} else {
			player.invincible[0] = false;
			player.invincible[1] = 0;
		}
	}
	
	//render = draw then update
	function renderPlatforms()
	{
		for (var i in platforms)
		{
			var plat = platforms[i];
			
			plat.dim[0] -= scroll_speed;
			ctx.fillStyle = plat.color;
			ctx.fillRect(plat.dim[0],plat.dim[1],plat.dim[2],plat.dim[3]);
			
			if (plat.dim[0] < (0-plat.dim[2]))
			{
				plat.active = false;
			}
		}
	}

	function renderProjectiles()
	{
		for (var i in projectiles)
		{
			var proj = projectiles[i];
			if (proj.active == true)
			{
				ctx.fillStyle = proj.color;
				ctx.fillRect(proj.coord[0],proj.coord[1],proj.size[0],proj.size[1]);
				
				if (proj.type == 'copter')
				{
					projUpdate(proj, true);
				}
				
				proj.coord[0] += proj.velocity[0];
			}
				
			if (proj.coord[0] > 1000 || proj.coord[0]+proj.size[0] < 0 || proj.active == false) 
			{
				proj.active = false
				projectiles.splice(i,1);
			}
		}		
	}
	
	function renderEnemies()
	{
		for (var i in enemies)
		{
			var enemy = enemies[i];
			if (enemy.active == true)
			{
				enemy.draw();
			}
		}	
	}		
	
	function gameButtons(e)
	{
		if (e.keyCode == 38) {
			if (player.land == true) { // if on ground
				jump.play();
				player.coord[1] = ( player.plat.dim[1]- player.size[1] ) - .000000001 ; // set slightly above plat
				player.plat = undefined; // clear platform cache
				player.land = false;
				player.velocity[1] += 8.5; // then jump
			}  // jump, only on ground;
		}
		
		if (e.keyCode == 90) { // Z
			player.fire[0] = true;
		}
		
		if (e.keyCode == 88) { // X
			if (player.power == 100) {
				for (var i in enemies) {
					if ( enemies[i].coord[0] < 900) { 
						enemies[i].land = false;
						enemies[i].velocity = [0, 100]; 
					}
				}
				player.power = 0;
				//$ power sound
			}
		}
		
		if (e.keyCode == 192) { // `(tilde), debug button
			//reset(); // soft game reset
			player.power = 100;
		}
	}
	
	function menuButtons(e)
	{
		if (e.keyCode == 38) { // up
		land.play();
			if (pointer.index > 0)
			{
				pointer.index--;
			}
			else
			{
				pointer.index = menuItems.length-1;
			}
		}
		else if (e.keyCode == 40) { // down
		land.play();
			if (pointer.index < menuItems.length-1)
			{
				pointer.index++;
			}
			else
				pointer.index = 0;
			}
		
		if (e.keyCode == 90) { // Z
			menuItems[pointer.index].select();
		}
	}
		
	function handleFiring()
	{
		if (player.fire[0] == true)
		{
			fire.play();
			projectiles.push(new proj(player.coord[0]+player.size[0], player.coord[1]+.2*player.size[1], player.type));
			player.fire[0] = false;
		}
		
		for (var i in enemies)
		{
			var enemy = enemies[i]
			if (enemy.type == 'copter') { enemy.fire[0] = true }
			if (enemy.active == true && enemy.fire[0] == true)
			{ 
				if (enemy.fire[1] > enemy.fire[2])
				{
					if (enemy.type == 'copter')	{
						projectiles.push(new proj(enemy.coord[0]+8, enemy.coord[1]+enemy.size[1]-4, enemy.type));
					} else {	
						projectiles.push(new proj(enemy.coord[0], enemy.coord[1]+.2*enemy.size[1], enemy.type));
					}
					enemy.fire[0] = false;
					enemy.fire[1] = 0;
				}
				else
				{
					enemy.fire[0] = false;
					enemy.fire[1]++;
				}
			}
		}
	}
	
	function updateAnimations()
	{
		if (player.land == true) {
			player.frame = 48;
			if (player.count < 5){
				if (frame_count % 2 == 0) { 
					player.count++;}
			} else {
				player.count = 0;
			}
		} else if (player.land == false) {
			player.frame = 300;
			player.count = 0;
		}
		
		for (var i in enemies) {
			if (enemies[i].type == 'elite') {
				if (enemies[i].land == true) {
					enemies[i].count = 45;
				} else {
					enemies[i].count = 0;
				}
			}
		}
	}
	
	function gameLoop()
	{
		frame_count++
		ctx.clearRect(0,0,1000,600);
		ctx.fillStyle = white
		ctx.fillRect(0,0,1000,600);
		
		// background scrolling
		for (var i in offsets)
		{
			if (offsets[i] < 1950) {
				offsets[i] += .3*scroll_speed;
			} else {
				offsets[i] = 0;
			}
		}
		
		ctx.drawImage(bg, 0,0, 1940, 600, 0-offsets[0],0, 1940, 600);
		ctx.drawImage(bg, 0,0, 1940, 600, 1940-offsets[1],0, 1940, 600);
		
		checkCollisions();

		handleFiring();
		
		renderPlatforms();
		renderEnemies();
		renderProjectiles();
		
		updateAnimations();
		
		handleInvincibility();
		if (player.invincible[1] % 2 == 0) {// for flashing 
			player.draw(); }
		
		projUpdate(player, true);
		for (var i in enemies) { 
			if (enemies[i].type !== 'copter') { 
				projUpdate(enemies[i], true); }
		}
		
		if (player.health < 0) { player.health = 0; }
		if (player.health > 100) { player.health = 100; }
		if (player.power > 100) { player.power = 100; }
		player.drawMeters();

		if (player.coord[1] > 900) { player.health = 0;}
	
		// handle death/gameover
		if ( player.health <= 0 && player.lives == 0 )
		{
			over_count++;
			oversfx.play();
			gameover();
		}
		else if ( player.health <= 0 && player.lives > 0)
		{
			lifeloss.play();
			var current_lives = player.lives;
			player = new spawnPlayer();
			player.velocity = [0,0];
			player.coord = [160, 0];
			player.lives = current_lives - 1;
			player.invincible[0] = true;
		}
	}
	
	function gameover()
	{
		
		ctx.fillStyle = black;
		ctx.font = "72px Courier" ;
		ctx.fillText('GAME OVER', 200, 300);
		if (over_count > 100) {
			over_count = 0;
			clearInterval(gameLoop);
			buildMenu();
		}
	}
	
	function reset()
	{
		clearInterval(main)
		platforms = [];
		projectiles = [];
		enemies = [];	
		buildGame();
	}
	
	function init()
	{
		// Set up our canvas
		canvas = document.getElementById("game");
		ctx = canvas.getContext('2d');
		
		
		ctx.clearRect(0,0,1000,600);
		
		buildMenu();
	}
	
	function buildMenu()
	{
		menuItems = [];	
		new mItem('Begin');
		menuItems[0].select = function () {
			buildGame();
		}
		new mItem('Settings (Doesn\'t work)');
		new mItem('Quit');
		
		pointer = new makePointer();
		
		document.removeEventListener("keydown", gameButtons, false);
		document.addEventListener("keydown", menuButtons, false);
		menuLoop = setInterval(titleMenu, 1000/fps);
	}
	
	function makePointer()
	{
		this.index = 0;
		this.count = 0;
	}
	
	function mItem(str)
	{
		this.index = menuItems.length;
		this.name = str;
		this.dim = [titleDim[0]+100, titleDim[1]+100+65*this.index];
		menuItems.push(this);
	}
	
	function titleMenu()
	{
		ctx.clearRect(0,0,1000,600);
		ctx.fillStyle = black;
		ctx.fillRect(0,0,1000,600);
		ctx.font = "96px Arial";
		ctx.fillStyle = white;
		ctx.fillText('Ray Spartan', titleDim[0], titleDim[1]);
		
		for (var i in menuItems)
		{
			var item = menuItems[i]
			ctx.font = "36px Arial"
			ctx.fillText(item.name, item.dim[0], item.dim[1]);
		}

		ctx.fillRect( menuItems[pointer.index].dim[0]-35, menuItems[pointer.index].dim[1]-22 , 20,  20);
	}
	
	function buildGame()
	{
		clearInterval(menuLoop);
		ctx.clearRect(0,0,1000,600);
		
		document.removeEventListener('keydown', menuButtons, false);
		document.addEventListener("keydown", gameButtons, false);
		
		jump = document.getElementById("jump");
		land = document.getElementById("land");
		fire = document.getElementById("fire");
		hit = document.getElementById("hit");
		lifeloss = document.getElementById("lifeloss");
		oversfx = document.getElementById("oversfx");
		
		platforms = [];
		// add platforms here
		new plat( 0, 500, 600, 100); // 0
		new plat( 650, 400, 600, 200); // 1
		new plat( 1300, 300, 600, 300); // 2
		new plat( 2200, 500, 2000, 200); // 3
		new plat( 2100, 200, 150, 10); // 4 - floater
		new plat( 2500, 300, 150, 10); // 5 - floater
		new plat( 4400, 400, 2000, 200); // 6
		new plat( 2800, 300, 150, 10);  // 7 - floater
		new plat( 3100, 300, 150, 10); // 8 - floater
		new plat( 6600, 500, 2000, 300); // 9
		
		enemies = [];
		// build enemies;
		new enemy('grunt', platforms[3], .7);
		new enemy('elite', platforms[7], .2);
		new enemy('copter', platforms[3], .8);
		new enemy('biker', platforms[6], .9);
		new enemy('copter', platforms[4], .5);
		new enemy('grunt', platforms[2], .1);
		new enemy('elite', platforms[8], .5);
		new enemy('elite', platforms[5], .2);
		new enemy('biker', platforms[3], .55);
		new enemy('copter', platforms[2], .55);		
		
		projectiles = [];
	
		// build player
		player = new spawnPlayer();
		
		gameLoop = setInterval(gameLoop, 1000/fps);
	}
	

	</script>
</head>

<body onload="init()">
	<canvas id="game" width="1000" height="600" />
	<audio src="jump.mp3" id="jump"></audio>
	<audio src="land.mp3" id="land"></audio>
	<audio src="fire.mp3" id="fire"></audio>
	<audio src="hit.mp3" id="hit"></audio>
	<audio src="lossoflife.mp3" id="lifeloss"></audio>
	<audio src="dead.mp3" id="oversfx"></audio>

</body>

</html>
